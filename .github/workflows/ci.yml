name: Openvote CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  GO_VERSION: '1.23'
  NODE_VERSION: '20'
  FLUTTER_VERSION: '3.22.0'

jobs:
  # ============================================
  # Backend Go â€” Build, Lint & Tests
  # ============================================
  backend:
    name: ðŸ”§ Backend (Go)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    services:
      postgres:
        image: postgis/postgis:15-3.3-alpine
        env:
          POSTGRES_USER: openvote_test
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: openvote_test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      rabbitmq:
        image: rabbitmq:3-management
        ports:
          - 5672:5672
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ¹ Setup Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: backend/go.sum

      - name: ðŸ“¦ TÃ©lÃ©chargement des dÃ©pendances
        run: go mod download

      - name: ðŸ” VÃ©rification des modules
        run: go mod verify

      - name: ðŸ§¹ Go Vet (analyse statique)
        run: go vet ./...

      - name: ðŸ—ï¸ Compilation
        run: CGO_ENABLED=1 go build -o /dev/null ./cmd/api/main.go

      - name: ðŸ§ª Tests unitaires
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: openvote_test
          DB_PASSWORD: testpassword
          DB_NAME: openvote_test_db
          RABBITMQ_URL: amqp://guest:guest@localhost:5672/
          JWT_SECRET: test-secret-key-ci
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: ðŸ“Š Rapport de couverture
        if: always()
        run: |
          go tool cover -func=coverage.out
          echo "### ðŸ“Š Couverture Backend" >> $GITHUB_STEP_SUMMARY
          go tool cover -func=coverage.out | tail -1 >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Frontend Web â€” Build & Lint
  # ============================================
  frontend:
    name: ðŸŒ Frontend (React/Vite)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./web

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: ðŸ“¦ Installation des dÃ©pendances
        run: npm ci || npm install

      - name: ðŸ§¹ Lint
        run: npm run lint || true

      - name: ðŸ—ï¸ Build de production
        run: npm run build

  # ============================================
  # Mobile Flutter â€” Analyze & Tests
  # ============================================
  mobile:
    name: ðŸ“± Mobile (Flutter)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./mobile

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ¦ Setup Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ðŸ“¦ Installation des dÃ©pendances
        run: flutter pub get

      - name: ðŸ” Analyse statique
        run: flutter analyze --no-fatal-infos || true

      - name: ðŸ§ª Tests unitaires
        run: flutter test --coverage || true

      - name: ðŸ“Š Rapport de couverture
        if: always()
        run: |
          if [ -f coverage/lcov.info ]; then
            echo "### ðŸ“Š Couverture Mobile" >> $GITHUB_STEP_SUMMARY
            echo "Fichier de couverture gÃ©nÃ©rÃ©." >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # Docker â€” Build des images
  # ============================================
  docker:
    name: ðŸ³ Docker Build
    runs-on: ubuntu-latest
    needs: [backend]

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ—ï¸ Build Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: false
          tags: openvote-backend:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # SÃ©curitÃ© â€” Scan de vulnÃ©rabilitÃ©s
  # ============================================
  security:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: [backend]

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ¹ Setup Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: ðŸ”’ Go Vulnerability Check
        working-directory: ./backend
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./... || true

  # ============================================
  # RÃ©sumÃ© final
  # ============================================
  summary:
    name: ðŸ“‹ Pipeline Summary
    runs-on: ubuntu-latest
    needs: [backend, frontend, mobile, docker, security]
    if: always()

    steps:
      - name: ðŸ“‹ RÃ©sumÃ© du pipeline
        run: |
          echo "## ðŸ—³ï¸ Openvote CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Mobile | ${{ needs.mobile.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker | ${{ needs.docker.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
